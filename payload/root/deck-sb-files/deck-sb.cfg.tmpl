# auto-generated by Deck SB ISO
# --- Debug while bringing up ---
set debug=video,gfxterm,font

# --- Video & terminal ---
insmod all_video
insmod gfxterm
insmod font

# --- Mode & payload BEFORE switching terminals ---
set gfxmode=1280x800,800x1280,auto
set gfxpayload=keep

# --- Load a font (fixing the missing 'then') ---
if [ -f "$prefix/unicode.pf2" ]; then
    loadfont $prefix/unicode.pf2
elif [ -f "/boot/grub/unicode.pf2" ]; then
    loadfont /boot/grub/unicode.pf2
elif [ -f "$prefix/fonts/unicode.pf2" ]; then
    loadfont $prefix/fonts/unicode.pf2
fi

# --- Switch terminal AFTER modules+font are ready ---
terminal_output gfxterm

set menu_color_normal=cyan/black
set menu_color_highlight=black/cyan
set pager=1
set color_normal=cyan/black
set color_highlight=black/cyan
set color_special=light-cyan/black
set color_title=cyan/black
set color_border=cyan/black

if [ -n "$grub_platform" ] && [ "$terminal_output" = "gfxterm" ]; then
    echo 'Deck Secure Boot GRUB ready.'
fi

set menu_label='Deck Secure Boot Loader'

menuentry 'SteamOS SB (shimless)' {
    set gfxpayload=text
    terminal_output console
    insmod part_gpt
    insmod btrfs
    insmod gzio
__DECK_SB_KERNEL_BLOCK__
}

# Automatically detect Windows, Clover, and the stock SteamOS loader when present
set deck_win_path=''
if search --file /EFI/Microsoft/Boot/bootmgfw.efi --set=deck_win; then
    set deck_win_path='/EFI/Microsoft/Boot/bootmgfw.efi'
elif search --file /EFI/Microsoft/bootmgfw.efi --set=deck_win; then
    set deck_win_path='/EFI/Microsoft/bootmgfw.efi'
fi

if test -n "$deck_win_path"; then
    menuentry 'Windows Boot Manager' {
        insmod part_gpt
        insmod fat
        insmod chain
        search --no-floppy --file $deck_win_path --set=root
        echo 'Tip: Boot Windows directly from the BIOS menu (Vol- + Power) to avoid Secure Boot prompts.'
        echo 'If you use Clover: press Vol+ + Power, then Boot From File -> efi/Microsoft/bootmgfw.efi'
        echo ''
        echo 'Recommended: Disable BitLocker so chainloading from this menu or Clover can load Windows correctly.'
        sleep 2
        set gfxpayload=text
        terminal_output console
        chainloader $deck_win_path
    }
fi

set deck_clover_path=''
if search --file /EFI/CLOVER/CLOVERX64.efi --set=deck_clover; then
    set deck_clover_path='/EFI/CLOVER/CLOVERX64.efi'
elif search --file /EFI/Clover/CLOVERX64.efi --set=deck_clover; then
    set deck_clover_path='/EFI/Clover/CLOVERX64.efi'
elif search --file /efi/clover/CLOVERX64.efi --set=deck_clover; then
    set deck_clover_path='/efi/clover/CLOVERX64.efi'
elif search --file /EFI/CLOVER/cloverx64.efi --set=deck_clover; then
    set deck_clover_path='/EFI/CLOVER/cloverx64.efi'
elif search --file /EFI/Clover/cloverx64.efi --set=deck_clover; then
    set deck_clover_path='/EFI/Clover/cloverx64.efi'
elif search --file /efi/clover/cloverx64.efi --set=deck_clover; then
    set deck_clover_path='/efi/clover/cloverx64.efi'
fi

if test -n "$deck_clover_path"; then
    menuentry 'Clover Bootloader' {
        set gfxpayload=text
        terminal_output console
        insmod part_gpt
        insmod fat
        insmod chain
        search --no-floppy --file $deck_clover_path --set=root
        chainloader $deck_clover_path
    }
fi

set deck_steamcl_path=''
if search --file /EFI/steamos/steamcl.efi --set=deck_steamcl; then
    set deck_steamcl_path='/EFI/steamos/steamcl.efi'
elif search --file /efi/steamos/steamcl.efi --set=deck_steamcl; then
    set deck_steamcl_path='/efi/steamos/steamcl.efi'
fi

if test -n "$deck_steamcl_path"; then
    menuentry 'SteamOS Official Bootloader' {
        set gfxpayload=text
        terminal_output console
        insmod part_gpt
        insmod fat
        insmod chain
        search --no-floppy --file $deck_steamcl_path --set=root
        chainloader $deck_steamcl_path
    }
fi

set deck_iso_file='/usr/local/share/deck-sb/arch/boot/x86_64/vmlinuz-linux'
set deck_iso_uuid=''
set deck_iso_devpath=''
if search --file $deck_iso_file --set=deck_iso_probe; then
    menuentry 'Deck Secure Boot Tools (On Disk)' {
        set gfxpayload=text
        terminal_output console
        insmod part_gpt
        insmod btrfs
        insmod gzio
        insmod probe
        search --no-floppy --file $deck_iso_file --set=deck_iso
        if [ -z "$deck_iso" ]; then
            echo 'Unable to locate Deck SB files on disk.'
            sleep 3
        else
            set root=$deck_iso
            probe --set=deck_iso_uuid --fs-uuid ($deck_iso)
            if [ -n "$deck_iso_uuid" ]; then
                set deck_iso_devpath="/dev/disk/by-uuid/$deck_iso_uuid"
            fi
        fi
        if [ -n "$deck_iso_uuid" ]; then
            echo 'Deck SB on-disk debug:'
            echo "  device: $deck_iso"
            echo "  uuid:   $deck_iso_uuid"
            set deck_iso_kernel="/usr/local/share/deck-sb/arch/boot/x86_64/vmlinuz-linux"
            set deck_iso_initrd="/usr/local/share/deck-sb/arch/boot/x86_64/initramfs-linux.img"
            set deck_iso_sfs="/usr/local/share/deck-sb/arch/x86_64/airootfs.sfs"
            check_iso_file() {
                set _label="$1"
                set _path="$2"
                if [ -f "($deck_iso)$_path" ]; then
                    echo "  $_label: ($deck_iso)$_path [OK]"
                else
                    echo "  $_label: ($deck_iso)$_path [MISSING]"
                fi
            }
            check_iso_file 'kernel' "$deck_iso_kernel"
            check_iso_file 'initrd' "$deck_iso_initrd"
            echo "  archisobasedir=usr/local/share/deck-sb/arch"
            echo "  archisodevice=$deck_iso_devpath"
            echo "  img_dev=$deck_iso_devpath"
            check_iso_file 'img_loop' "$deck_iso_sfs"
            sleep 3
            linux ($deck_iso)/usr/local/share/deck-sb/arch/boot/x86_64/vmlinuz-linux archisobasedir=usr/local/share/deck-sb/arch archisodevice=$deck_iso_devpath img_dev=$deck_iso_devpath img_loop=/usr/local/share/deck-sb/arch/x86_64/airootfs.sfs copytoram=n
            initrd ($deck_iso)/usr/local/share/deck-sb/arch/boot/x86_64/initramfs-linux.img
        else
            echo 'Unable to determine filesystem UUID for deck-sb files.'
            sleep 3
        fi
    }
fi
